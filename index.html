<!doctype html>
<html lang="en" class="no-js">

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fairfield Public Library</title>

  <!-- link to Montserrat font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">

  <!-- leaflet css -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <link rel="stylesheet" href="src/leaflet.groupedlayercontrol.css" />

  <!-- custom style here -->
  <style type="text/css">
    body,
    html {
      margin: 0;
      padding: 0;
    }

    /* Set map parameters */
    #map {
      position: fixed;
      bottom: 0px;
      width: 100%;
      top: 52px;
    }

    header {
      background-image: url('img/bookshelf.jpeg');
      position: fixed;
      top: 0px;
      width: 100%;
      height: 52px;
      background-color: #000000;
      box-shadow: 0px 0px 5px black;
      z-index: 800;
    }

    h1 {
      color: black;
      font-size: 16px;
      display: inline-block;
      margin-top: 0.5em;
      margin-bottom: 0.0em;
      margin-left: 0.8em;
      margin-right: 0;
      font-weight: bold;
      font-family: "Montserrat";
    }

    h2 {
      font-size: 12px;
      color: black;
      display: inline-block;
      margin-top: 0.25em;
      margin-bottom: 0.0em;
      margin-left: 1.0em;
      margin-right: 0;
      font-weight: bold;
      font-family: "Montserrat";
    }

    h4 {
      font-size: 16px;
      margin: 4px;
    }

    h5 {
      font-size: 13px;
      margin: 4px;
    }

    .legend, .blegend {
      padding: 6px 8px;
      font-size: 1em;
      background: rgba(217, 217, 217, 0.8);
      color: rgb(0, 0, 0);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      width: auto !important;
      white-space: nowrap;
    }

    .legend ul, .blegend ul {
      list-style-type: none;
      padding: 0;
      margin: 12px 4px 0;
    }

    .legend li, .blegend li {
      height: 22px;
    }

    .legend span, .blegend span {
      width: 30px;
      height: 20px;
      float: left;
      margin-right: 10px;
    }
/*
    .legend .square.present {
      background-color: rgba(135, 206, 235, 0.5);
    }

    .legend .square.not-present {
      background-color: rgba(211, 211, 211, 0.5);
    }
*/
  </style>

</head>

<body>

  <header>
    <h1>Annual Public Reading Needs Met by the Fairfield Public Library</h1><br>
    <h2>Alecs Schmidt Mickunas, MLIS, Fairfield Public Library Director, Fairfield, Iowa</h2>
  </header>

  <!-- map -->
  <div id="map"></div>

  <!-- leaflet js -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <!-- d3js -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <!-- chroma -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.2.1/chroma.min.js"></script>
  <script src="src/leaflet.groupedlayercontrol.js"></script>

  <!-- javascript below -->
  <script>
    // initialize the map
    const map = L.map('map');

    // add a basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 15,
      minZoom: 7
    }).addTo(map);

    // Add a scale bar
    L.control.scale({
      position: 'bottomleft'
    }).addTo(map);

    // Create a legend control
    const legendControl = L.control({ position: 'bottomright' });
    // Create another legend control for the borrowing percentage 
    const borrowLegend = L.control({ position: 'bottomright' });
    
    // Create a legend div within the legend control
    legendControl.onAdd = function (map) {
      const legend = L.DomUtil.create('div', 'legend');
      return legend;
    };
    // Create a blegend div within the legend control
    borrowLegend.onAdd = function (map) {
      const blegend = L.DomUtil.create('div', 'blegend');
      return blegend;
    };


    // Add the legend controls to the map
    legendControl.addTo(map);
    borrowLegend.addTo(map);
    // Hide the legend controls
    $('.legend').hide();
    $('.blegend').hide();    

    // select the newly created legend, select and populate the heading,
    // creating an unordered list for the class ranges and store as reference to variable
    const legend = $('.legend').html("<h4>Books Borrowed<br>Per Capita</h4><ul>"+
                                     "<li><span style='background: #bd0026'></span> 7.39 &mdash; 9.03</li>"+
                                     "<li><span style='background: #f03b20'></span> 3.94 &mdash; 7.38</li>"+
                                     "<li><span style='background: #fd8d3c'></span> 1.56 &mdash; 3.93</li>"+
                                     "<li><span style='background: #fecc5c'></span> 1.01 &mdash; 1.55</li>"+
                                     "<li><span style='background: #ffffb2'></span> 0.00 &mdash; 1.00</li>");
    
    const blegend = $('.blegend').html("<h4>Percent of Population<br>Borrowing Books</h4><ul>"+
                                     "<li><span style='background: #bd0026'></span> 19% &mdash; 24%</li>"+
                                     "<li><span style='background: #f03b20'></span> 16% &mdash; 19%</li>"+
                                     "<li><span style='background: #fd8d3c'></span> 7% &mdash; 15%</li>"+
                                     "<li><span style='background: #fecc5c'></span> 5% &mdash; 6%</li>"+
                                     "<li><span style='background: #ffffb2'></span> 0% &mdash; 4%</li>");

    // Define an empty layer so that you can turn off precinct stats
    const emptyLayer = L.layerGroup().addTo(map);

    // Load the data asynchronously
    d3.queue()
      .defer(d3.json, 'data/jefferson-co.geojson') //the Jefferson County geojson file
      .defer(d3.json, 'data/cities.geojson') //city and town boundaries for Jefferson County
      .defer(d3.json, 'data/precinct-stats.geojson') //the state precincts in Jefferson County
      .defer(d3.json, 'data/user-data.geojson') //the library borrowing data
      .await(drawMap); //load the layers after the map loads

    // Provide instructions for making the map
    function drawMap(err, jeffco, cty, precs, usr) {

      // create Leaflet object with geometry data and add to map
      const jeffersonCounty = L.geoJson(jeffco, {
        style: function(feature) {
            return {
              color: 'black',
              weight: 1,
              fillOpacity: 0,
              fillColor: 'rgb(0,0,0)'
            };
        },

        onEachFeature: function(feature, layer) {
          // bind a tooltip to the layer
          layer.bindTooltip('<b>Jefferson County</b>', {sticky: true});
          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            layer.setStyle({
              weight: 1.5,
              color: 'yellow'
            });
          });

          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            layer.setStyle({
              weight: 1,
              color: 'black'
            });
          });

        }

      }).addTo(map);

      // create Leaflet object with geometry data and add to map
      const towns = L.geoJson(cty, {
        style: function(feature) {
          return {
            color: 'black',
            weight: 0.75,
            fillOpacity: 0,
            fillColor: 'rgb(0,0,0)'
          };
        },

        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>'+props.CITY_NAME+'</b>', {sticky: true});
          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            layer.setStyle({
              weight: 1,
              color: 'yellow'
            });
          });

          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            layer.setStyle({
              weight: 0.75,
              color: 'black'
            });
          });

        }

      }).addTo(map);        

      // create Leaflet object with geometry data and add to map
      const precinctBorrowers = L.geoJson(precs, {
        style: function(feature) {
          return {
            color: 'black',
            weight: 0.5,
            fillOpacity: 0.5,
            fillColor: borrowersColor(feature.properties.borrowers_percap)
          };
        },
        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>PRECINCT: '+props.DISTRICT+'</b><br>'+props.borrowers_percap*100+'% of Population are Borrowers', {sticky: true});
          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            e.target.setStyle({
              weight: 1.5
            });
          });
          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            e.target.setStyle({
              weight: 0.5
            });
          });
        }
      });

      // create Leaflet object with geometry data and add to map
      const precinctBooks = L.geoJson(precs, {
        style: function(feature) {
          return {
            color: 'black',
            weight: 0.5,
            fillOpacity: 0.5,
            fillColor: booksColor(feature.properties.books_percap)
          };
        },
        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>PRECINCT: '+props.DISTRICT+'</b><br>'+props.books_percap+' Books Borrowed Per Person', {sticky: true});
          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            e.target.setStyle({
              weight: 1.5
            });
          });
          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            e.target.setStyle({
              weight: 0.5
            });
          });
        }
      });      

      // create Leaflet object with geometry data and add to map
      const userData = L.geoJson(usr, {
        pointToLayer: function(feature, latlng) { // using pointToLayer...
          return L.circleMarker(latlng, {
            fillColor: '#698DAD', // set the fill color
            color: 'black', // set the border color
            opacity: 0.5, // set the opacity of the border
            weight: 1, // set the weight of the border
            fillOpacity: 0.8, // set the opacity of the fill color
            radius: Math.sqrt(feature.properties.Books / Math.PI) * 2 // set the radii of the circles
          });
        },
        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>'+props.Address+'</b><br>Books Borrowed: '+props.Books, {sticky: true});
          //define what happens on mouseover
          layer.on("mouseover", function(e) {
            layer.setStyle({
              fillOpacity: 0.5,
              color: 'yellow'
            });
          });

          //define what happens on mouseout
          layer.on("mouseout", function(e) {
            layer.setStyle({
              fillOpacity: 0.8,
              color: 'black'
            });
          });

        }
      }).addTo(map);    

      // first set the zoom/center to the dataLayer's extent
      map.fitBounds(jeffersonCounty.getBounds());

      // Create an object with the overlay layers
      const groupedOverlays = {
        "Each Borrower": {
          "Books Borrowed": userData
        },
        "Jurisdictions": {
          "Jefferson County": jeffersonCounty,
          "Cities and Towns": towns
        },        
        "Borrowing Rates by Precinct": {
          "Per Capita Books Borrowed": precinctBooks,
          "Percent Borrowers": precinctBorrowers,
          "Turn Off": emptyLayer
        }
      };      


      // Add the layer control to the map
      L.control.groupedLayers(null, groupedOverlays, { position: 'topright', collapsed: false, exclusiveGroups: ["Borrowing Rates by Precinct"] }).addTo(map);

      // Event listener for the overlayadd event
      map.on('overlayadd', function (eventLayer) {
        // Ensure layer order is maintained
        if (eventLayer.layer === precinctBorrowers) {
          towns.bringToBack();
          precinctBorrowers.bringToBack();
          jeffersonCounty.bringToBack();
          $('.legend').hide(); // hide the legend control
          $('.blegend').show(); // show this legend control
        } if (eventLayer.layer === precinctBooks) {
          towns.bringToBack();          
          precinctBooks.bringToBack();
          jeffersonCounty.bringToBack();
          $('.legend').show(); // show the legend control
          $('.blegend').hide(); // hide this legend control
        } if (eventLayer.layer === emptyLayer) {
          $('.legend').hide(); // hide the legend control
          $('.blegend').hide(); // hide this legend control
        } if (eventLayer.layer === jeffersonCounty) {
          towns.bringToBack();          
          precinctBorrowers.bringToBack();
          precinctBooks.bringToBack();
          jeffersonCounty.bringToBack();
        } if (eventLayer.layer === towns) {
          towns.bringToBack();          
          precinctBorrowers.bringToBack();
          precinctBooks.bringToBack();          
          jeffersonCounty.bringToBack();
        }
      });

    }; // end drawMap function

    // Add a function to style the preincts by percentage of borrowers
    function borrowersColor(d) {
      return d > 0.19 ? '#bd0026' :
        d > 0.15 ? '#f03b20' :
        d > 0.06 ? '#fd8d3c' :
        d > 0.04 ? '#fecc5c' :
        d > 0.00 ? '#ffffb2' :
        'rgba(0,0,0,0.0)'; // supported by Microsoft Edge
    };

    // Add a function to style the preincts by books borrowed per person
    function booksColor(d) {
      return d > 7.38 ? '#bd0026' :
        d > 3.93 ? '#f03b20' :
        d > 1.55 ? '#fd8d3c' :
        d > 1.00 ? '#fecc5c' :
        d > 0.00 ? '#ffffb2' :
        'rgba(0,0,0,0.0)'; // supported by Microsoft Edge
    };    

  </script>

</body>

</html>